<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NBA Player Betting Data</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --bg-elevated: #111827;
      --bg-subtle: #0b1020;
      --accent: #20c997;
      --accent-soft: rgba(32, 201, 151, 0.2);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-subtle: #1f2933;
      --error: #f97373;
      --radius-lg: 18px;
      --radius-xl: 24px;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.55);
      --transition-fast: 180ms ease-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #101827 0, #020617 40%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 1120px;
      background: linear-gradient(
        135deg,
        rgba(32, 201, 151, 0.08),
        rgba(15, 23, 42, 0.95)
      );
      border-radius: 28px;
      padding: 24px 22px 28px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(26px);
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      justify-content: space-between;
      gap: 0.6rem;
      margin-bottom: 1.8rem;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .brand-badge {
      width: 34px;
      height: 34px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 0%, #6ee7b7, #0f766e);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #020617;
      font-size: 0.9rem;
      font-weight: 800;
      letter-spacing: 0.05em;
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.45);
    }

    h1 {
      font-size: 1.3rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-main);
    }

    .tagline {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .search-panel {
      margin-bottom: 1.8rem;
      background: radial-gradient(circle at top left, #020617, #020617 48%, #020617);
      border-radius: var(--radius-xl);
      padding: 16px 16px 18px;
      border: 1px solid var(--border-subtle);
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .search-panel label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      flex-basis: 100%;
    }

    .search-row {
      display: flex;
      gap: 0.75rem;
      width: 100%;
      flex-wrap: wrap;
    }

    .search-row input[type="text"] {
      flex: 1 1 220px;
      min-width: 0;
      padding: 0.7rem 0.85rem;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-subtle);
      color: var(--text-main);
      font-size: 0.92rem;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast);
    }

    .search-row input[type="text"]::placeholder {
      color: #6b7280;
    }

    .search-row input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(32, 201, 151, 0.35);
      background: #020617;
    }

    .button-primary {
      padding: 0.68rem 1.25rem;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #20c997, #059669);
      color: #020617;
      font-weight: 600;
      font-size: 0.9rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      box-shadow: 0 12px 24px rgba(16, 185, 129, 0.4);
      transition: transform 140ms ease-out, box-shadow 140ms ease-out,
        filter 140ms ease-out;
    }

    .button-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .button-primary span.icon {
      font-size: 1rem;
    }

    .button-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 28px rgba(16, 185, 129, 0.5);
      filter: brightness(1.02);
    }

    .button-primary:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 8px 16px rgba(16, 185, 129, 0.35);
    }

    .helper-text {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }

    .status-text {
      margin-top: 0.35rem;
      font-size: 0.78rem;
      color: var(--error);
      display: none;
    }

    .status-text.visible {
      display: block;
    }

    .status-text.success {
      color: var(--accent);
    }

    .player-section,
    .matchup-section {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 200ms ease-out, transform 200ms ease-out;
      margin-bottom: 1.5rem;
    }

    .player-section.hidden,
    .matchup-section.hidden {
      opacity: 0;
      transform: translateY(8px);
      pointer-events: none;
      height: 0;
      overflow: hidden;
      margin-bottom: 0;
    }

    .player-heading-row,
    .matchup-heading-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.4rem;
      margin-bottom: 1rem;
    }

    .player-name,
    .matchup-title {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .player-name-pill,
    .matchup-pill {
      font-size: 0.74rem;
      text-transform: uppercase;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid rgba(32, 201, 151, 0.4);
    }

    .context-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .player-grid,
    .matchup-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
    }

    .card {
      background: radial-gradient(circle at top left, #0b1120, #020617);
      border-radius: var(--radius-lg);
      padding: 14px 14px 16px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.45);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      min-height: 220px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.4rem;
    }

    .card-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-main);
    }

    .card-subtitle {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .pill {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border-subtle);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .stat-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    .stat-table thead {
      background: rgba(15, 23, 42, 0.95);
    }

    .stat-table th,
    .stat-table td {
      padding: 0.35rem 0.35rem;
      text-align: left;
    }

    .stat-table th {
      font-weight: 600;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      border-bottom: 1px solid #111827;
    }

    .stat-table tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.5);
    }

    .stat-table tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.15);
    }

    .stat-table tbody tr:hover {
      background: rgba(32, 201, 151, 0.08);
    }

    .stat-label {
      color: var(--text-main);
      font-weight: 500;
    }

    .stat-value {
      text-align: right;
      color: var(--text-muted);
      font-variant-numeric: tabular-nums;
    }

    .stat-placeholder {
      opacity: 0.65;
      font-style: italic;
    }

    .matchup-controls {
      margin-bottom: 0.8rem;
      background: radial-gradient(circle at top left, #020617, #020617 48%);
      border-radius: var(--radius-xl);
      padding: 12px 14px;
      border: 1px solid var(--border-subtle);
    }

    .matchup-controls-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }

    .matchup-row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .matchup-row input[type="text"] {
      flex: 1 1 200px;
      min-width: 0;
      padding: 0.6rem 0.8rem;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-subtle);
      color: var(--text-main);
      font-size: 0.88rem;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast);
    }

    .matchup-row input[type="text"]::placeholder {
      color: #6b7280;
    }

    .matchup-row input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(32, 201, 151, 0.35);
      background: #020617;
    }

    @media (max-width: 640px) {
      .app-shell {
        padding: 18px 14px 22px;
      }

      header {
        margin-bottom: 1.4rem;
      }

      .player-grid,
      .matchup-grid {
        grid-template-columns: 1fr;
      }

      .card {
        min-height: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <div class="brand-badge">NB</div>
        <div>
          <h1>NBA Player Betting Hub</h1>
          <div class="tagline">
            Live NBA.com play-type data
          </div>
        </div>
      </div>
    </header>

    <section class="search-panel">
      <label for="player-input">Step 1 ¬∑ Search player</label>
      <form id="search-form" class="search-row">
        <input
          type="text"
          id="player-input"
          placeholder="Type an NBA player name (e.g. Jamal Murray)"
          autocomplete="off"
        />
        <button type="submit" class="button-primary" id="search-btn">
          <span class="icon">üîç</span>
          <span>Load Player</span>
        </button>
      </form>
      <div id="status-text" class="status-text"></div>
      <p class="helper-text">
        Connected to Flask backend at 10.0.0.48:5000
      </p>
    </section>

    <section id="player-section" class="player-section hidden">
      <div class="player-heading-row">
        <div class="player-name">
          <span id="player-name">Player Name</span>
          <span class="player-name-pill">Live Data</span>
        </div>
        <div class="context-label">Play-type scoring breakdown</div>
      </div>

      <div class="player-grid">
        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Play Type Points</div>
              <div class="card-subtitle">
                Total points scored by play type
              </div>
            </div>
            <span class="pill">Offense</span>
          </div>

          <table class="stat-table">
            <thead>
              <tr>
                <th>Play Type</th>
                <th>Points</th>
              </tr>
            </thead>
            <tbody id="playstyle-tbody">
              <tr><td colspan="2" class="stat-placeholder">Loading...</td></tr>
            </tbody>
          </table>
        </article>
      </div>
    </section>

    <section id="matchup-section" class="matchup-section hidden">
      <div class="matchup-heading-row">
        <div class="matchup-title">
          <span id="matchup-heading-text">Player vs Team Defense</span>
          <span class="matchup-pill">Live Matchup</span>
        </div>
        <div class="context-label">
          Step 2 ¬∑ Choose opponent defense
        </div>
      </div>

      <div class="matchup-controls">
        <div class="matchup-controls-label">
          Select defense to evaluate against this scorer
        </div>
        <form id="team-form" class="matchup-row">
          <input
            type="text"
            id="team-input"
            placeholder="Type a team (e.g. Bucks)"
            autocomplete="off"
          />
          <button type="submit" class="button-primary" id="team-btn">
            <span class="icon">üéØ</span>
            <span>Analyze Matchup</span>
          </button>
        </form>
        <div id="team-status-text" class="status-text"></div>
      </div>

      <div class="matchup-grid">
        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Defense vs Play Types</div>
              <div class="card-subtitle">
                Defensive PPP allowed & rank
              </div>
            </div>
            <span class="pill">Defense</span>
          </div>

          <table class="stat-table">
            <thead>
              <tr>
                <th>Play Type</th>
                <th>Rank</th>
                <th>PPP</th>
              </tr>
            </thead>
            <tbody id="defense-tbody">
              <tr><td colspan="3" class="stat-placeholder">Enter team...</td></tr>
            </tbody>
          </table>
        </article>
      </div>
    </section>

    <section id="ai-analysis-section" class="matchup-section hidden">
      <div class="matchup-heading-row">
        <div class="matchup-title">
          <span>ü§ñ AI Matchup Analysis</span>
          <span class="matchup-pill">Powered by Gemini</span>
        </div>
        <div class="context-label">
          Step 3 ¬∑ Get intelligent insights
        </div>
      </div>

      <div class="matchup-controls">
        <div class="matchup-controls-label">
          Get AI-powered analysis of this matchup
        </div>
        <button class="button-primary" id="ai-analyze-btn" style="width: 100%;">
          <span class="icon">‚ú®</span>
          <span>Analyze Matchup with AI</span>
        </button>
      </div>

      <article class="card" id="ai-response-card" style="display: none;">
        <div class="card-header">
          <div>
            <div class="card-title">AI Analysis</div>
            <div class="card-subtitle" id="ai-subtitle">
              Analysis in progress...
            </div>
          </div>
          <span class="pill">Gemini</span>
        </div>
        <div id="ai-response-content" style="color: var(--text-main); line-height: 1.6; font-size: 0.88rem;">
          <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è≥</div>
            <div>Analyzing matchup...</div>
          </div>
        </div>
      </article>
    </section>
  </div>

  <script>
    // Configure your Flask API URL here - UPDATED TO 10.0.0.48
    const API_URL = 'http://10.0.0.48:5000/api';

    const form = document.getElementById("search-form");
    const input = document.getElementById("player-input");
    const searchBtn = document.getElementById("search-btn");
    const playerSection = document.getElementById("player-section");
    const playerNameEl = document.getElementById("player-name");
    const statusText = document.getElementById("status-text");
    const playstyleTbody = document.getElementById("playstyle-tbody");

    const matchupSection = document.getElementById("matchup-section");
    const matchupHeadingText = document.getElementById("matchup-heading-text");
    const teamForm = document.getElementById("team-form");
    const teamInput = document.getElementById("team-input");
    const teamBtn = document.getElementById("team-btn");
    const teamStatusText = document.getElementById("team-status-text");
    const defenseTbody = document.getElementById("defense-tbody");

    const aiAnalysisSection = document.getElementById("ai-analysis-section");
    const aiAnalyzeBtn = document.getElementById("ai-analyze-btn");
    const aiResponseCard = document.getElementById("ai-response-card");
    const aiResponseContent = document.getElementById("ai-response-content");
    const aiSubtitle = document.getElementById("ai-subtitle");

    let currentPlayerName = "";
    let currentPlayerData = null;
    let currentTeamName = "";
    let currentDefenseData = null;

    const playTypeMapping = {
      "Isolation": "iso",
      "Transition": "transition",
      "Pick-and-Roll": "pr_handler",
      "Roll Man": "pr_rollman",
      "Post-Up": "postup",
      "Spot-Up": "spotup",
      "Hand-Off": "handoff",
      "Cut": "cut",
      "Off Screen": "offscreen",
      "Putbacks": "putbacks"
    };

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = input.value.trim();

      statusText.classList.remove("visible", "success");
      teamStatusText.classList.remove("visible");

      if (!name) {
        statusText.textContent = "Type a player name to start.";
        statusText.classList.add("visible");
        return;
      }

      searchBtn.disabled = true;
      statusText.textContent = "Loading player data...";
      statusText.classList.add("visible", "success");

      try {
        const response = await fetch(`${API_URL}/player/${encodeURIComponent(name)}`);
        
        if (!response.ok) {
          throw new Error("Player not found");
        }

        const data = await response.json();
        currentPlayerName = data.player;
        currentPlayerData = data.data;

        playerNameEl.textContent = currentPlayerName;
        matchupHeadingText.textContent = `${currentPlayerName} vs Team Defense`;
        
        displayPlayerData(data.data);
        
        playerSection.classList.remove("hidden");
        matchupSection.classList.remove("hidden");
        
        statusText.textContent = `Loaded ${currentPlayerName}`;
        setTimeout(() => statusText.classList.remove("visible"), 2000);

      } catch (err) {
        statusText.textContent = err.message || "Player not found. Check spelling or try another name.";
        statusText.classList.remove("success");
        statusText.classList.add("visible");
        playerSection.classList.add("hidden");
        matchupSection.classList.add("hidden");
      } finally {
        searchBtn.disabled = false;
      }
    });

    function displayPlayerData(data) {
      // Sort by points descending
      const sorted = data.sort((a, b) => b.pts - a.pts);
      
      playstyleTbody.innerHTML = sorted.map(item => `
        <tr>
          <td class="stat-label">${item.playType}</td>
          <td class="stat-value">${item.pts.toFixed(1)} PTS</td>
        </tr>
      `).join('');
    }

    teamForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const team = teamInput.value.trim();

      teamStatusText.classList.remove("visible", "success");

      if (!currentPlayerName) {
        teamStatusText.textContent = "Load a player first.";
        teamStatusText.classList.add("visible");
        return;
      }

      if (!team) {
        teamStatusText.textContent = "Type a team name to analyze.";
        teamStatusText.classList.add("visible");
        return;
      }

      teamBtn.disabled = true;
      teamStatusText.textContent = "Loading defense data...";
      teamStatusText.classList.add("visible", "success");

      try {
        const response = await fetch(`${API_URL}/defense/${encodeURIComponent(team)}`);
        
        if (!response.ok) {
          throw new Error("Team not found");
        }

        const data = await response.json();
        displayDefenseData(data.data);
        
        currentTeamName = data.team;
        currentDefenseData = data.data;
        
        // Show AI analysis section
        aiAnalysisSection.classList.remove("hidden");
        aiResponseCard.style.display = "none";
        
        teamStatusText.textContent = `Loaded ${data.team} defense`;
        setTimeout(() => teamStatusText.classList.remove("visible"), 2000);

      } catch (err) {
        teamStatusText.textContent = err.message || "Team not found. Try another name (e.g. 'Lakers').";
        teamStatusText.classList.remove("success");
        teamStatusText.classList.add("visible");
        defenseTbody.innerHTML = '<tr><td colspan="3" class="stat-placeholder">Team not found</td></tr>';
      } finally {
        teamBtn.disabled = false;
      }
    });

    function displayDefenseData(data) {
      // Filter to only play types the player has
      const playerPlayTypes = new Set(currentPlayerData.map(d => d.playType));
      const filtered = data.filter(d => playerPlayTypes.has(d.playType));
      
      defenseTbody.innerHTML = filtered.map(item => `
        <tr>
          <td class="stat-label">${item.playType}</td>
          <td class="stat-value">#${item.rank}</td>
          <td class="stat-value">${item.ppp.toFixed(2)}</td>
        </tr>
      `).join('');
    }

    // AI Analysis functionality with Gemini
    aiAnalyzeBtn.addEventListener("click", async () => {
      if (!currentPlayerName || !currentTeamName) {
        return;
      }

      aiAnalyzeBtn.disabled = true;
      aiResponseCard.style.display = "block";
      aiSubtitle.textContent = "Searching the web and analyzing...";
      aiResponseContent.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
          <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîç</div>
          <div>Gemini is searching the web for latest info...</div>
          <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">This may take 10-15 seconds</div>
        </div>
      `;

      try {
        const response = await fetch(`${API_URL}/ai-analysis`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            playerName: currentPlayerName,
            teamName: currentTeamName,
            playerStats: currentPlayerData,
            defenseStats: currentDefenseData
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || "AI analysis failed");
        }

        const data = await response.json();
        const analysisText = data.analysis;

        // Format the response with better styling
        const formattedAnalysis = analysisText
          .split('\n')
          .map(line => {
            line = line.trim();
            if (!line) return '<div style="height: 0.5rem;"></div>';
            
            // Check if line is a header (starts with number, **, or ###)
            if (/^\d+\./.test(line) || /^\*\*.*\*\*/.test(line) || /^###/.test(line)) {
              const cleanLine = line.replace(/\*\*/g, '').replace(/^###\s*/, '');
              return `<div style="font-weight: 600; color: var(--accent); margin-top: 1rem; margin-bottom: 0.5rem;">${cleanLine}</div>`;
            }
            
            // Bold text within lines
            line = line.replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--accent);">$1</strong>');
            
            return `<p style="margin-bottom: 0.75rem; line-height: 1.6;">${line}</p>`;
          })
          .join('');

        aiResponseContent.innerHTML = formattedAnalysis;
        aiSubtitle.textContent = `${currentPlayerName} vs ${currentTeamName} ‚Ä¢ Powered by Gemini + Web Search`;

      } catch (err) {
        aiResponseContent.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: var(--error);">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
            <div>Analysis failed. Please try again.</div>
            <div style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--text-muted);">${err.message}</div>
          </div>
        `;
        aiSubtitle.textContent = "Analysis failed";
      } finally {
        aiAnalyzeBtn.disabled = false;
      }
    });
  </script>
</body>
</html>